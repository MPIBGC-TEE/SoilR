# Example about how to use the LVTM fuction

library(SoilR)

source("VTLM.R") # Run this if your working directory contains this file. Otherwise, source the LVTM function from where it is stored and make it available in the Global Environment
source("collect_by_layer.R") # Idem
source("collect_by_pool.R") # Idem
source("solveVTLM.R")

# Step 1. Prepare what you need for a SoilR pool model
years<-seq(1941.5,2019,by=0.5)
LitterInput<-700 
k1<-1/2
k2<-1/30
a21<-0.5*k1 # 50% of C decomposed from pool 1 moves to pool 2
a12<-0.1*k2 # 10% of C decomposed from pool 2 moves to pool 1
initialC<-c(0,0) # You can put any number here. They will be ignored because steady-state will be assumed
initialF14<-c(0,0) # Same here. For the depth simulation the age of the steady-state carbon will be used to set initial F14C
AtmF14<-Hua2021$NHZone2[,1:2] # Atmospheric radiocarbon curve for Northern Hemisphere zone 2 in Delta14C

#Step 2. Create SoilR pool model
PoolModel=TwopFeedbackModel14(t=years,ks=c(k1, k2),C0=initialC, 
                       F0_Delta14C=initialF14,In=LitterInput, a21=a21,a12=a12,inputFc=AtmF14)

# Step 3. Create Vertical Transport model
depthLayers<-c(1:10)
rootInputs<-rep(0,times=length(depthLayers))
downwardTransferRate<-0.05
upwardTransferRate<-0

TwopDepth<-VTLM(Model=PoolModel, lyrs=depthLayers, latIn = rootInputs, vrm=exp(-depthLayers*2),
                d=downwardTransferRate, u=upwardTransferRate, ivalF14 = "model")

# Step 4a. Solve using a new interface. Useful to see how the individual pools change with depth
results<-solveVTLM(VTLM=TwopDepth, npool = 2, nlayer = length(depthLayers))

targetYear<-which(years==2010)

plot(results$C14[,1,targetYear], -depthLayers, type="l", xlim=c(0,300), xlab="Delta14C", ylab="Depth")
lines(results$C14[,2,targetYear], -depthLayers, col=2)

# Step 4b. Solve the vertical transport model and aggregate by pool and layer
Cdt<-getC(TwopDepth)
C14dt<-getF14(TwopDepth)

L14t<-collect_by_layer(Cdt,C14dt,nlayer=10,npool=2)
P14t<-collect_by_pool(Cdt,C14dt,nlayer=10,npool=2)

# Step 5. Plot the results
plot(AtmF14, type="l", ylab="Mean Delta14C in permil", lty=1)
matlines(TwopDepth@times,L14t$F14C, lty=1, col=2:11) # Find a better color palette
legend("topright", paste("Layer", 1:10), lty=1, col=2:11, bty="n")

matplot(TwopDepth@times, L14t$C, type="l", lty=1, col=2:11, ylim=c(5000, 10000), 
        xlab="Year", ylab="Carbon stock")
legend("bottomright", paste("Layer", 1:10), lty=1, col=2:11, bty="n")

plot(tail(L14t$C, 1), -depthLayers, xlab="C stock", ylab="Depth", type="b")
plot(tail(L14t$F14C, 1), -depthLayers, xlab="Delta14C", ylab="Depth", type="b")

plot(AtmF14, type="l", lty=1, ylab="Mean Delta14C in permil")
matlines(TwopDepth@times,P14t$F14C, lty=1, col=2:3)
legend("topright", c("Fast pool", "Slow pool"), lty=1, col=2:3, bty="n")
